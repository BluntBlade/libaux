#include <assert.h>
#include <stdio.h>

#include "str/utf8.h"

uint8_t utf8_bytes_map[128] = {
    // 0x00 ~ 0x7F
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,

    // 0x80 ~ 0xBF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    // 0xC0 ~ 0xDF
    0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,

    //  0xE0 ~ 0xEF
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,

    // 0xF0 ~ 0xF7
    0x44, 0x44, 0x44, 0x44,

    // 0xF8 ~ 0xFF
    0x00, 0x00, 0x00, 0x00,
};

bool utf8_count(const char_t * start, uint32_t * bytes, uint32_t * chars)
{
    const char_t * pos = NULL;
    const char_t * end = NULL;
    uint32_t i = 0;
    uint32_t code = 0; // 跟随字节前2比特集合
    uint32_t cnt = 0; // 跟随字节数
    uint32_t ena = 0; // 累加开关
    uint32_t max = 0; // 检查字符数上限

    assert(bytes != NULL);
    assert(chars != NULL);

    max = *bytes < *chars ? *bytes : *chars;
    end = start + *bytes;
    for (pos = start; i < max && pos < end; ++i) {
        // UTF-8 字符数必然少于或等于字节数
        if ((ena = (pos[0] >> 7))) {
            cnt += (ena &= (pos[0] >> 6));
            cnt += (ena &= (pos[0] >> 5));
            cnt += (ena &= (pos[0] >> 4));
            cnt &= 0x3 + (ena & (pos[0] >> 3));
            if (cnt == 0) break; // 首字节匹配 0b10xxxxxx 或 0b11111xxx

            // 0x00101010 => 0x2A
            code = ((pos[1] & 0xC0) >> 2) + ((pos[2] & 0xC0) >> 4) + ((pos[3] & 0xC0) >> 6);
            if ((code >> ((3 - cnt) * 2)) != (0x2A >> ((3 - cnt) * 2))) break;

            pos += cnt;
            code = 0;
            cnt = 0;
        } // if
        pos += 1;
    } // for

    *bytes = pos - start + cnt;
    *chars = i;
    return i == max || pos == end;
} // utf8_count
